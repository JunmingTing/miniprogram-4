# 头像上传问题调试指南

## 问题现象
1. 上传完图片后无法在自定义弹窗内预览
2. 无法在profile页面看到自己上传的头像
3. 上传成功率低（6次上传只成功2次）

## 已修复的问题

### 1. 预览不显示问题 ✅
**原因**: `t-avatar` 组件不支持本地临时文件路径
**解决方案**: 改用 `<image>` 组件显示预览
**修改文件**: `miniprogram/components/avatar-upload-dialog/avatar-upload-dialog.wxml`

### 2. 界面不更新问题 ✅
**原因**: 事件传递和数据绑定问题
**解决方案**: 增加详细的日志和错误处理
**修改文件**: `miniprogram/pages/profile/profile.ts`

### 3. 上传成功率低问题 ✅
**原因**: 缺少文件验证和详细错误处理
**解决方案**: 增加文件存在性检查和详细错误信息
**修改文件**: `miniprogram/components/avatar-upload-dialog/avatar-upload-dialog.ts`

## 调试步骤

### 步骤1: 检查云开发环境
1. 在profile页面点击"测试云函数"
2. 查看测试结果：
   - 基础云函数：应该显示"正常"
   - 云存储权限：应该显示"正常"

### 步骤2: 检查控制台日志
打开微信开发者工具的控制台，查看以下日志：

#### 选择图片时：
```
开始选择图片，来源类型: ['album'] 或 ['camera']
选择图片成功: {...}
临时文件信息: {path: "...", size: ..., type: "..."}
设置预览图片: ...
预览图片设置完成，当前状态: {...}
```

#### 上传时：
```
开始上传头像，用户ID: ..., 文件路径: ...
文件信息验证成功: {...}
云存储路径: avatars/用户ID.jpg
上传进度: 0%, 10%, 20%...
头像上传成功: {...}
文件ID: cloud://...
触发上传成功事件，fileID: ...
```

#### 界面更新时：
```
收到头像上传成功事件: {...}
开始更新头像，fileID: ...
当前用户信息: {...}
界面已更新，新头像: ...
更新后的用户信息: {...}
开始更新用户信息: {...}
云函数调用成功: {...}
数据库更新成功
新的用户信息: {...}
本地存储已更新
```

#### Profile页面显示时：
```
Profile页面显示，当前用户信息: {...}
用户头像URL: cloud://...
从本地存储获取的用户信息: {...}
用户头像URL: cloud://...
```

### 步骤3: 检查云存储
1. 在微信开发者工具中，点击"云开发"
2. 进入"存储" → "文件管理"
3. 查看 `avatars` 文件夹下是否有文件
4. 文件名应该是用户ID（如：`用户ID.jpg`）

### 步骤4: 检查数据库
1. 在微信开发者工具中，点击"云开发"
2. 进入"数据库" → "users" 集合
3. 查看用户记录的 `avatar` 字段是否更新

## 常见问题及解决方案

### 问题1: 预览不显示
**症状**: 选择图片后弹窗内看不到预览
**解决**: 已修复，使用 `<image>` 组件替代 `t-avatar`

### 问题2: Profile页面头像不显示
**症状**: 上传成功后弹窗可以预览，但profile页面头像不显示
**原因**: `t-avatar` 组件不支持云存储的 `fileID` 格式
**解决方案**: 已修复，改用 `<image>` 组件显示头像

**修改内容**:
- 将 `t-avatar` 组件替换为 `<image>` 组件
- 添加头像占位符显示
- 更新CSS样式支持圆形头像显示

### 问题3: 上传失败
**症状**: 点击"确认上传"后显示错误
**可能原因**:
- 网络连接问题
- 云存储权限不足
- 文件格式不支持
- 文件大小超限

**解决步骤**:
1. 检查网络连接
2. 运行"测试云函数"检查云存储权限
3. 确保图片格式为 JPG/PNG
4. 确保文件大小小于5MB

### 问题4: 界面不更新
**症状**: 上传成功后profile页面头像没有变化
**可能原因**:
- 事件传递失败
- 数据绑定问题
- 云函数调用失败

**解决步骤**:
1. 查看控制台日志确认事件是否触发
2. 检查 `updateUserInfo` 云函数是否正常
3. 确认用户ID是否正确

### 问题5: 上传成功率低
**症状**: 多次上传只有部分成功
**可能原因**:
- 网络不稳定
- 云存储配额不足
- 并发上传冲突

**解决步骤**:
1. 确保网络稳定
2. 检查云存储配额
3. 避免同时上传多个文件

## 部署说明

### 1. 部署新的云函数
```bash
# 部署云存储检查云函数
cd cloudfunctions/checkStorage
npm install
# 在微信开发者工具中右键上传并部署
```

### 2. 测试功能
1. 登录小程序
2. 点击头像打开上传弹窗
3. 选择图片查看预览
4. 确认上传查看进度
5. 检查profile页面头像是否更新

## 技术细节

### 文件路径结构
```
avatars/
├── 用户ID1.jpg
├── 用户ID2.jpg
└── ...
```

### 数据流程
1. 用户选择图片 → 临时文件路径
2. 显示预览 → `<image>` 组件（弹窗内）
3. 确认上传 → 云存储 `/avatars/用户ID.jpg`
4. 上传成功 → 触发 `upload-success` 事件
5. 更新界面 → 立即显示新头像（profile页面使用 `<image>` 组件）
6. 更新数据库 → 保存头像URL到用户记录

### 头像显示组件
- **弹窗预览**: 使用 `<image>` 组件，支持本地临时文件路径
- **Profile页面**: 使用 `<image>` 组件，支持云存储 `fileID`
- **占位符**: 当没有头像时显示用户图标
- **样式**: 圆形头像，160rpx × 160rpx

### 错误处理
- 文件大小检查（5MB限制）
- 文件格式验证
- 网络错误重试
- 权限错误提示
- 详细错误日志

## 联系支持
如果问题仍然存在，请提供：
1. 控制台完整日志
2. 云函数测试结果
3. 具体的错误信息
4. 操作步骤描述
