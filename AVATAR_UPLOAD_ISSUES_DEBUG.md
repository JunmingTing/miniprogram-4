# 头像上传问题调试指南

## 问题1: 更换头像弹窗中当前头像不显示 ✅ 已修复

### 问题描述
点击"更换头像"按钮后，弹窗中的"当前头像"区域没有显示用户现有的头像。

### 原因分析
- 弹窗使用的是 `t-avatar` 组件
- 传入的 `currentAvatar` 是云存储的 `fileID` 格式（如 `cloud://...`）
- `t-avatar` 组件不支持云存储的 `fileID` 格式

### 解决方案 ✅
已将 `t-avatar` 组件替换为 `<image>` 组件，支持云存储的 `fileID` 格式。

### 修改内容
1. **WXML文件**: 将 `t-avatar` 替换为 `<image>` 组件
2. **WXSS文件**: 添加了头像容器和占位符样式
3. **功能增强**: 当没有头像时显示用户图标占位符

---

## 问题2: 拍照上传功能问题 🔍 需要调试

### 问题描述
使用拍照功能时，图片只显示在预览区域，但没有真正上传到云存储。

### 可能原因分析

#### 原因1: 用户操作流程问题
- 用户拍照后只看到了预览，但没有点击"确认上传"按钮
- 这是正常的设计流程：拍照 → 预览 → 确认上传

#### 原因2: 上传过程中出现错误
- 网络问题导致上传失败
- 云存储权限问题
- 文件路径问题

#### 原因3: API使用问题
- `wx.chooseMedia` API使用不当
- 参数配置错误

### 调试步骤

#### 步骤1: 检查控制台日志
打开微信开发者工具的控制台，查看以下日志：

**拍照时应该看到：**
```
用户点击拍照按钮
开始选择图片，来源类型: ['camera']
选择图片成功: {...}
临时文件信息: {...}
设置预览图片: wxfile://...
来源类型: ['camera']
是否为拍照: true
预览图片设置完成，当前状态: {...}
```

**点击确认上传时应该看到：**
```
用户点击确认上传按钮
当前选中的文件路径: wxfile://...
开始上传头像，文件路径: wxfile://...
文件信息验证成功: {...}
云存储路径: avatars/用户ID.jpg
上传进度: 0%
上传进度: 50%
上传进度: 100%
头像上传成功: {...}
文件ID: cloud://...
触发上传成功事件，fileID: cloud://...
```

#### 步骤2: 检查用户操作流程
1. 点击"更换头像"按钮
2. 点击"拍照"按钮
3. 拍照完成后，应该看到预览界面
4. **重要**: 点击"确认上传"按钮
5. 等待上传完成

#### 步骤3: 检查云存储
1. 在微信开发者工具中，点击"云开发"
2. 进入"存储" → "文件管理"
3. 查看 `avatars` 文件夹下是否有新文件

#### 步骤4: 检查网络和权限
1. 确保网络连接正常
2. 运行"测试云函数"检查云存储权限
3. 确保图片格式为 JPG/PNG
4. 确保文件大小小于5MB

### 常见问题排查

#### 问题A: 拍照后没有显示预览
**可能原因**: 相机权限被拒绝
**解决方案**: 
1. 检查小程序权限设置
2. 重新授权相机权限
3. 查看控制台是否有权限错误

#### 问题B: 点击确认上传后没有反应
**可能原因**: 
1. 文件路径无效
2. 网络问题
3. 云存储权限问题

**解决方案**:
1. 查看控制台错误信息
2. 检查网络连接
3. 运行云函数测试

#### 问题C: 上传进度卡住
**可能原因**: 网络不稳定或文件过大
**解决方案**:
1. 检查网络连接
2. 尝试压缩图片
3. 重新尝试上传

### 测试用例

#### 测试1: 从相册选择
1. 点击"从相册选择"
2. 选择一张图片
3. 查看预览是否正常
4. 点击"确认上传"
5. 检查是否上传成功

#### 测试2: 拍照上传
1. 点击"拍照"
2. 拍照一张图片
3. 查看预览是否正常
4. 点击"确认上传"
5. 检查是否上传成功

#### 测试3: 重新选择
1. 选择一张图片
2. 点击"重新选择"
3. 选择另一张图片
4. 确认上传
5. 检查是否上传成功

### 技术细节

#### 上传流程
1. 用户选择图片 → 临时文件路径
2. 显示预览 → `<image>` 组件
3. 确认上传 → 云存储 `/avatars/用户ID.jpg`
4. 上传成功 → 触发 `upload-success` 事件
5. 更新界面 → 立即显示新头像
6. 更新数据库 → 保存头像URL到用户记录

#### API使用
- **选择图片**: `wx.chooseMedia`
- **上传文件**: `wx.cloud.uploadFile`
- **更新数据库**: 云函数 `updateUserInfo`

#### 文件路径格式
- **临时文件**: `wxfile://tmp_xxx.jpg`
- **云存储文件**: `cloud://cloud1-4ghl6bw58e8ba561.636c-cloud1-4ghl6bw58e8ba561-1324567890/avatars/用户ID.jpg`

### 联系支持
如果按照以上步骤仍无法解决问题，请提供：
1. 控制台完整日志
2. 操作步骤描述
3. 错误截图
4. 设备信息（iOS/Android，微信版本等）

